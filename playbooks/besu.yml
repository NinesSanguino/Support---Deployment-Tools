---
- name: BESU nodes - folder creation
  hosts: all
  become: true
  tasks:
    - name: Create config folder       
      file:
        path: "/var/besu/config"
        state: directory
        mode: '0777'    
        owner: root
        group: root
        recurse: yes

    - name: Create data folder       
      file:
        path: "/var/besu/database"
        state: directory
        mode: '0777'    
        owner: root
        group: root
        recurse: yes

    - name: Get config files from Nexus
      get_url:
        url: "{{URL_GENESIS}}"
        dest: "/var/besu/config/genesis.json"
        url_username: "{{NEXUS_USER}}"
        url_password: "{{NEXUS_PASS}}"

- name: BESU nodes deployment
  hosts: i3m-node1
  become: true
  tasks:
    - name: Get config files
      get_url:
        url: "{{ item.src }}"
        dest: "/var/besu/config/{{ item.dest }}"
        url_username: "{{NEXUS_USER}}"
        url_password: "{{NEXUS_PASS}}"
      loop:
        - { src: "{{URL_KEY1}}", dest: "key"}
        - { src: "{{URL_KEY_PUB1}}", dest: "key.pub"}

    - name: Run latest BESU docker image
      docker_container:
        name: besu
        image: hyperledger/besu:latest
        env:
          BESU_DATA_PATH: "/besu/database"
          BESU_NODE_PRIVATE_KEY_FILE: "/besu/config/key"
          BESU_HOST_ALLOWLIST: "*"
          BESU_P2P_HOST: "0.0.0.0"
          BESU_RPC_HTTP_ENABLED: "true"
          BESU_RPC_HTTP_HOST: "0.0.0.0"
          BESU_RPC_WS_ENABLED: "true"
          BESU_RPC_WS_HOST: "0.0.0.0"
        volumes:
          - "/var/besu/config:/besu/config"
          - "/var/besu/database:/besu/database"
        ports:
          - 30303:30303/udp
          - 30303:30303/tcp
          - 8545:8545/tcp
          - 8546:8546/tcp
        state: started

- name: BESU nodes deployment
  hosts: i3m-node2
  become: true
  tasks:
  
    - name: Get config files
      get_url:
        url: "{{ item.src }}"
        dest: "/var/besu/config/{{ item.dest }}"
        url_username: "{{NEXUS_USER}}"
        url_password: "{{NEXUS_PASS}}"
      loop:
        - { src: "{{URL_KEY2}}", dest: "key"}
        - { src: "{{URL_KEY_PUB2}}", dest: "key.pub"}

    - name: Run latest BESU docker image
      docker_container:
        name: besu
        image: hyperledger/besu:latest
        env:
          BESU_DATA_PATH: "/besu/database"
          BESU_NODE_PRIVATE_KEY_FILE: "/besu/config/key"
          BESU_HOST_ALLOWLIST: "*"
          BESU_P2P_HOST: "0.0.0.0"
          BESU_RPC_HTTP_ENABLED: "true"
          BESU_RPC_HTTP_HOST: "0.0.0.0"
          BESU_RPC_WS_ENABLED: "true"
          BESU_RPC_WS_HOST: "0.0.0.0"
          BESU_BOOTNODES: "{{BOOTNODE}}"
        volumes:
          - "/var/besu/config:/besu/config"
          - "/var/besu/database:/besu/database"
        ports:
          - 30303:30303/udp
          - 30303:30303/tcp
          - 8545:8545/tcp
          - 8546:8546/tcp
        state: started

- name: BESU nodes deployment
  hosts: i3m-node3
  become: true
  tasks:
  
    - name: Get config files
      get_url:
        url: "{{ item.src }}"
        dest: "/var/besu/config/{{ item.dest }}"
        url_username: "{{NEXUS_USER}}"
        url_password: "{{NEXUS_PASS}}"
      loop:
        - { src: "{{URL_KEY3}}", dest: "key"}
        - { src: "{{URL_KEY_PUB3}}", dest: "key.pub"}

    - name: Run latest BESU docker image
      docker_container:
        name: besu
        image: hyperledger/besu:latest
        env:
          BESU_DATA_PATH: "/besu/database"
          BESU_NODE_PRIVATE_KEY_FILE: "/besu/config/key"
          BESU_HOST_ALLOWLIST: "*"
          BESU_P2P_HOST: "0.0.0.0"
          BESU_RPC_HTTP_ENABLED: "true"
          BESU_RPC_HTTP_HOST: "0.0.0.0"
          BESU_RPC_WS_ENABLED: "true"
          BESU_RPC_WS_HOST: "0.0.0.0"
          BESU_BOOTNODES: "{{BOOTNODE}}"
        volumes:
          - "/var/besu/config:/besu/config"
          - "/var/besu/database:/besu/database"
        ports:
          - 30303:30303/udp
          - 30303:30303/tcp
          - 8545:8545/tcp
          - 8546:8546/tcp
        state: started

- name: BESU nodes deployment
  hosts: i3m-node4
  become: true
  tasks:
  
    - name: Get config files
      get_url:
        url: "{{ item.src }}"
        dest: "/var/besu/config/{{ item.dest }}"
        url_username: "{{NEXUS_USER}}"
        url_password: "{{NEXUS_PASS}}"
      loop:
        - { src: "{{URL_KEY4}}", dest: "key"}
        - { src: "{{URL_KEY_PUB4}}", dest: "key.pub"}

    - name: Run latest BESU docker image
      docker_container:
        name: besu
        image: hyperledger/besu:latest
        env:
          BESU_DATA_PATH: "/besu/database"
          BESU_NODE_PRIVATE_KEY_FILE: "/besu/config/key"
          BESU_HOST_ALLOWLIST: "*"
          BESU_P2P_HOST: "0.0.0.0"
          BESU_RPC_HTTP_ENABLED: "true"
          BESU_RPC_HTTP_HOST: "0.0.0.0"
          BESU_RPC_WS_ENABLED: "true"
          BESU_RPC_WS_HOST: "0.0.0.0"
          BESU_BOOTNODES: "{{BOOTNODE}}"
        volumes:
          - "/var/besu/config:/besu/config"
          - "/var/besu/database:/besu/database"
        ports:
          - 30303:30303/udp
          - 30303:30303/tcp
          - 8545:8545/tcp
          - 8546:8546/tcp
        state: started
